name: k6 load tests

on:
  push:
    branches: [main, develop, k6-fix]
  pull_request:
    branches: [main, develop, k6-fix]

jobs:
  # üåê Job para entorno DEMO (bd "normal")
  k6-demo:
    runs-on: ubuntu-latest

    env:
      # URL del backend DEMO desplegado (antes API_BASE_URL_DEMO)
      API_BASE_URL: ${{ secrets.API_BASE_URL_DEMO }}
      # Credenciales del ADMIN en DEMO (para stress-admin-reports)
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL_DEMO }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD_DEMO }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: k6 - load listings
        run: |
          k6 run --summary-export=summary-load-listings.json k6/load-listings.js

      - name: k6 - spyke listings
        run: |
          k6 run --summary-export=summary-spyke-listings.json k6/spyke-listings.js

      - name: k6 - stress listings
        run: |
          k6 run --summary-export=summary-stress-listings.json k6/stress-listings.js

      - name: k6 - stress admin reports
        run: |
          k6 run --summary-export=summary-admin-reports.json k6/stress-admin-reports.js

  # ‚öôÔ∏è Job para entorno PERF (bd cta_perf)
  k6-perf:
    runs-on: ubuntu-latest

    env:
      # URL del backend PERF (sembrado con seed_perf)
      API_BASE_URL: ${{ secrets.API_BASE_URL_PERF }}
      # Credenciales de los usuarios PERF
      AGENCY_EMAIL: ${{ secrets.AGENCY_EMAIL_PERF }} # ej: agency_perf@cta.com
      AGENCY_PASSWORD: ${{ secrets.AGENCY_PASSWORD_PERF }} # ej: Perf1234!
      BUYER_EMAIL: ${{ secrets.BUYER_EMAIL_PERF }} # ej: buyer_perf@cta.com
      BUYER_PASSWORD: ${{ secrets.BUYER_PASSWORD_PERF }} # ej: Perf1234!

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: k6 - stress purchases
        run: |
          k6 run --summary-export=summary-stress-purchases.json k6/stress-purchases.js
